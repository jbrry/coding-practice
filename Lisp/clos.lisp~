(defclass bowling-game ()
  ((total
    :initarg :total    ;; name for slot when initialising
    :initform 0
    :accessor total)   ;; name for slot when accessing
   (rolls
    :initform '()
    :accessor rolls)
   (current-roll
    :initarg :current-roll
    :initform 0
    :accessor current-roll))
  (:documentation "Score a bowling game"))

(defmethod init-rolls ((g bowling-game) placeholder)
  (setf (rolls g) (loop repeat 21 collect placeholder)))


(defmethod roll ((g bowling-game) pins)
  "set roll at i to pins and incremenet current-roll index"
  (with-accessors ((rolls rolls)
		   (current-roll current-roll))
      g
    (setf (elt (rolls g) (current-roll g)) pins)
    (setf (current-roll g) (incf (current-roll g)))))

(defmethod display-status ((g bowling-game) arg1)
  (with-accessors ((total total)
		   (rolls rolls)
		   (current-roll current-roll))
      g
    (format t "status for game [~a]: total: ~a, rolls: ~a, current-roll: ~a" arg1 total rolls current-roll)))
	
(defun create-game ()
  (make-instance 'bowling-game))


(defmethod sum-of-rolls-in-frame ((g bowling-game) frame-idx)
  (with-accessors ((rolls rolls))
      g
    (+ (nth frame-idx (rolls g)) (nth (+ frame-idx 1) (rolls g)))))


(defmethod strike-bonus ((g bowling-game) frame-idx)
  (with-accessors ((rolls rolls))
      g
    (+ (nth (+ frame-idx 1) (rolls g)) (nth (+ frame-idx 2) (rolls g)))))


(defmethod spare-bonus ((g bowling-game) frame-idx)
  (with-accessors ((rolls rolls))
      g
    (nth (+ frame-idx 2) (rolls g))))


(defmethod is-strike ((g bowling-game) frame-idx)
  (with-accessors ((rolls rolls))
      g
      (eq (nth frame-idx (rolls g)) 10)))


(defmethod is-spare ((g bowling-game) frame-idx)
  (with-accessors ((rolls rolls))
      g
    (eq (+ (nth frame-idx (rolls g)) (nth (+ frame-idx 1) (rolls g))) 10)))


(defmethod score ((g bowling-game) arg1)
  (with-accessors ((total total)
		   (current-roll current-roll))
      g
    (let ((frame-idx 0))
      (loop for frame from 1 to 10 do
	(if (is-strike g frame-idx)
	    (progn
	      (format t "Player ~A got a strike!" arg1)
	      (setf (total g) (+ (total g) (strike-bonus g frame-idx) 10))
	      (incf frame-idx 1))
	    (if (is-spare g frame-idx)
		(progn
		  (format t "Player ~A got a spare!" arg1)
		  (setf (total g) (+ (total g) (spare-bonus g frame-idx) 10))
		  (incf frame-idx 2))
		(progn
		  (setf (total g) (+ (total g) (sum-of-rolls-in-frame x frame-idx)))
		  (print (sum-of-rolls-in-frame x frame-idx))
		  (incf frame-idx 2)))))
      (total g)
      )))

	
(defun test ()
  (setq x (create-game))
  (init-rolls x 0)
  (loop for r in '(10 5 5 2 3 4 6) do
    (roll x r))
  (score x "james")
					;(display-status x (princ-to-string x)
  )


(describe (make-instance 'bowling-game :total 100))
(describe x)
